<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signal Alerts â€” Bet Point</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#007bff">
<link rel="apple-touch-icon" href="./icon-1024x1024.png">

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<style>
html, body { margin:0; height:100%; width:100%; font-family:Arial,sans-serif; background:#000; }
iframe { width:100%; height:100%; border:none; display:block; }
#loginOverlay { position:fixed; inset:0; background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999; color:#fff; }
#loginOverlay img { width:96px; height:96px; margin-bottom:16px; }
#loginOverlay input { padding:12px; font-size:16px; width:220px; border-radius:6px; border:none; margin-bottom:12px; }
#loginOverlay button { padding:12px 18px; font-size:16px; border-radius:6px; border:none; background:#007bff; color:#fff; cursor:pointer; }
#loginError { color:#ff4d4d; margin-top:12px; }
#spinner { border:4px solid rgba(255,255,255,0.2); border-top:4px solid #007bff; border-radius:50%; width:36px; height:36px; animation:spin 1s linear infinite; margin-top:12px; display:none; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <img src="./icon-1024x1024.png" alt="Logo">
  <h2>Enter Password</h2>
  <input type="password" id="rowIdInput" placeholder="Password">
  <button onclick="submitRowId()">Submit</button>
  <div id="loginError"></div>
  <div id="spinner"></div>
</div>

<!-- APP -->
<iframe id="appFrame"></iframe>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

/* ================= CONFIG ================= */
const SUPABASE_URL = "https://iznxrukdqbrcxjzhvwyk.supabase.co";
const SUPABASE_KEY = "<YOUR_ANON_KEY>";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const APP_URL      = 'https://bet-point.appsmith.com/app/signals/page1-68b217383a43874978908b5c?embed=true';
const POLL_MS      = 5000;
const HEARTBEAT_MS = 10000;

let rowId = null;
let loginCode = null;
let pollTimer = null;
let heartbeatTimer = null;
let gracePeriod = false;

/* ================= HEARTBEAT ================= */
function startHeartbeat() {
  stopHeartbeat();
  heartbeatTimer = setInterval(() => {
    if (!rowId || !loginCode) return;
    console.log("ðŸ«€ Heartbeat ping");
  }, HEARTBEAT_MS);
}
function stopHeartbeat() { if (heartbeatTimer) { clearInterval(heartbeatTimer); heartbeatTimer = null; } }
document.addEventListener("visibilitychange", () => document.visibilityState==='visible'?startHeartbeat():stopHeartbeat());

/* ================= AUTH STATE ================= */
function setAuthState(isAuthed, reason=null){
  const overlay = document.getElementById('loginOverlay');
  const frame = document.getElementById('appFrame');
  if(isAuthed){
    overlay.style.display='none';
    frame.src=APP_URL;
    startHeartbeat();
  } else {
    localStorage.removeItem('rowId');
    localStorage.removeItem('loginCode');
    if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
    stopHeartbeat();
    frame.src='about:blank';
    overlay.style.display='flex';
    document.getElementById('loginError').textContent="Logged out: "+reason;
  }
}

/* ================= AUTO LOGIN ================= */
window.addEventListener('DOMContentLoaded', async()=>{
  const savedRow = localStorage.getItem('rowId');
  const savedCode = localStorage.getItem('loginCode');
  if(savedRow && savedCode){
    rowId=savedRow;
    loginCode=savedCode;
    setAuthState(true);
    startPolling();
  }
});

/* ================= LOGIN ================= */
async function submitRowId(){
  const error = document.getElementById('loginError');
  const spinner = document.getElementById('spinner');
  rowId=document.getElementById('rowIdInput').value.trim();
  if(!rowId) return;
  error.textContent='';
  spinner.style.display='block';
  stopPolling();
  loginCode=null;
  gracePeriod=true;

  try{
    // Poll signal_login for latest code after submit
    let code=null;
    const start=Date.now();
    while(!code && Date.now()-start<5000){
      const { data, error: fetchErr } = await supabase
        .from('signal_login')
        .select('code')
        .eq('row_id', rowId)
        .order('created_at',{ascending:false})
        .limit(1)
        .maybeSingle();
      if(!fetchErr && data?.code){ code=data.code; break; }
      await new Promise(r=>setTimeout(r,500));
    }

    if(!code){ error.textContent='Login failed'; return; }

    loginCode=code;
    localStorage.setItem('rowId', rowId);
    localStorage.setItem('loginCode', loginCode);
    setAuthState(true);

    setTimeout(()=>gracePeriod=false,4000);
    setTimeout(startPolling,10000);

  } catch(e){ console.error(e); error.textContent='Server error'; }
  finally{ spinner.style.display='none'; }
}

/* ================= POLLING ================= */
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  const pollFn=async()=>{
    if(gracePeriod) return;
    if(!rowId || !loginCode) return;
    try{
      const { data } = await supabase
        .from('signal_login')
        .select('code')
        .eq('row_id', rowId)
        .order('created_at',{ascending:false})
        .limit(1)
        .maybeSingle();
      if(!data?.code || data.code!==loginCode){
        console.warn("Auth invalid, logging out");
        setAuthState(false,"Logged in elsewhere");
      }
    } catch(e){ console.error("Polling exception",e); }
  };
  pollFn();
  pollTimer=setInterval(pollFn,POLL_MS);
}
function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

</script>

</body>
</html>
