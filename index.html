<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signal Alerts â€” Bet Point</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#007bff">
<link rel="apple-touch-icon" href="./icon-1024x1024.png">

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<style>
html, body { margin:0; height:100%; width:100%; font-family:Arial,sans-serif; background:#000; }
iframe { width:100%; height:100%; border:none; display:block; }
#loginOverlay { position:fixed; inset:0; background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999; color:#fff; }
#loginOverlay img { width:96px; height:96px; margin-bottom:16px; }
#loginOverlay input { padding:12px; font-size:16px; width:220px; border-radius:6px; border:none; margin-bottom:12px; }
#loginOverlay button { padding:12px 18px; font-size:16px; border-radius:6px; border:none; background:#007bff; color:#fff; cursor:pointer; }
#loginError { color:#ff4d4d; margin-top:12px; }
#spinner {
  border: 4px solid rgba(255, 255, 255, 0.2);
  border-top: 4px solid #007bff;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  animation: spin 1s linear infinite;
  margin-top:12px;
  display:none;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <img src="./icon-1024x1024.png" alt="Logo">
  <h2>Enter Password</h2>
  <input type="password" id="rowIdInput" placeholder="Password">
  <button onclick="submitRowId()">Submit</button>
  <div id="loginError"></div>
  <div id="spinner"></div>
</div>

<!-- APP -->
<iframe id="appFrame"></iframe>

<script>
/* CONFIG */
const VERIFY_URL   = 'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/verify-link';
const REGISTER_URL = 'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/register-device';
const CHECK_LAST4  = 'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/checklast4';
const APP_URL      = 'https://bet-point.appsmith.com/app/signals/page1-68b217383a43874978908b5c?embed=true';
const POLL_MS      = 15000;
const deviceType   = /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'web';
const ONESIGNAL_APP_ID = "2b94ad70-2518-44d4-aaef-bfb95739206f";

let rowId = null;
let linkId = null;
let pollTimer = null;
let gracePeriod = false;

/* ================= AUTO LOGIN ================= */
window.addEventListener('DOMContentLoaded', () => {
  const savedRow = localStorage.getItem('rowId');
  const savedLink = localStorage.getItem('linkId');
  if (savedRow && savedLink) {
    rowId = savedRow;
    linkId = savedLink;
    unlockApp();
    initOneSignal(rowId);
    startPolling();
  }
});

/* ================= LOGIN ================= */
async function submitRowId() {
  const error = document.getElementById('loginError');
  const spinner = document.getElementById('spinner');
  rowId = document.getElementById('rowIdInput').value.trim();
  if (!rowId) return;
  error.textContent = '';
  spinner.style.display = 'block'; // show spinner

  try {
    const res = await fetch(VERIFY_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ row_id: rowId })
    });
    const data = await res.json();

    if (!data.valid) {
      error.textContent = 'Invalid password';
      spinner.style.display = 'none';
      return;
    }

    linkId = data.link_id;
    localStorage.setItem('rowId', rowId);
    localStorage.setItem('linkId', linkId);

    unlockApp();
    initOneSignal(rowId);

    // Grace period: prevent immediate kick
    gracePeriod = true;
    setTimeout(() => { gracePeriod = false; }, 4000);

    startPolling();
  } catch {
    error.textContent = 'Server error';
  } finally {
    spinner.style.display = 'none'; // hide spinner
  }
}

/* ================= UI ================= */
function unlockApp() {
  document.getElementById('loginOverlay').style.display = 'none';
  const frame = document.getElementById('appFrame');
  if (!frame.src) frame.src = APP_URL;
}

function forceLogout(reason) {
  console.warn("â›” KICKED:", reason);
  localStorage.removeItem('rowId');
  localStorage.removeItem('linkId');
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = null;
  document.getElementById('appFrame').src = '';
  document.getElementById('loginOverlay').style.display = 'flex';
}

/* ================= ONESIGNAL INIT ================= */
function initOneSignal(rowId) {
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: ONESIGNAL_APP_ID,
      path:"/signals/",
      serviceWorkerPath:"signals/OneSignalSDKWorker.js",
      serviceWorkerUpdaterPath:"signals/OneSignalSDKUpdaterWorker.js",
      notifyButton:{ enable:true }
    });

    // Automatically set external ID
    try {
      await OneSignal.login(rowId); // ðŸ”‘ Sets external_id = rowId
      const playerId = await OneSignal.getUserId();

      // Save playerId to backend
      await fetch(REGISTER_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          rowId: rowId,
          linkId: linkId,
          one_signal_id: playerId,
          device_type: deviceType
        })
      });
      console.log("External ID set and playerId saved:", rowId, playerId);
    } catch(err) {
      console.error("Failed to set external ID:", err);
    }
  });
}

/* ================= HARD KICK POLLING ================= */
function startPolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    if (gracePeriod) return; // skip checking during grace period

    const rowIdLocal = localStorage.getItem('rowId');
    if (!rowIdLocal) return;

    try {
      const res = await fetch(CHECK_LAST4, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ row_id: rowIdLocal })
      });

      if (!res.ok) return console.error("Poll fetch error:", res.statusText);

      const data = await res.json();
      if (!data.valid) {
        console.warn("Last 4 player IDs mismatch:", data.last4_player_ids);
        forceLogout("Detected multiple devices or player_id change");
      }
    } catch(err) {
      console.error("Polling error:", err);
    }
  }, POLL_MS);
}
</script>
</body>
</html> 
