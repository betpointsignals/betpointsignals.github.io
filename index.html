<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signal Alerts — Bet Point</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#007bff">
<link rel="apple-touch-icon" href="./icon-1024x1024.png">

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  /* ================= CONFIG ================= */
  const SUPABASE_URL = "https://iznxrukdqbrcxjzhvwyk.supabase.co";
  const SUPABASE_KEY = "<YOUR_ANON_KEY>"; // anon/public key
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const APP_URL = 'https://bet-point.appsmith.com/app/signals/page1-68b217383a43874978908b5c?embed=true';

  let rowId = null;
  let loginCode = null;
  let checkInterval = null;
  let autoLoginDisabled = false;
  let isSubmitting = false;

  /* ================= AUTH STATE ================= */
  function setAuthState(isAuthed, reason = null) {
    const overlay = document.getElementById('loginOverlay');
    const frame = document.getElementById('appFrame');

    if (isAuthed) {
      overlay.style.display = 'none';
      frame.src = APP_URL;
      startCheckLoop();
    } else {
      localStorage.removeItem('rowId');
      localStorage.removeItem('loginCode');
      frame.src = 'about:blank';
      overlay.style.display = 'flex';
      stopCheckLoop();
      if (reason) document.getElementById('loginError').textContent = "Logged out: " + reason;
      autoLoginDisabled = true;
    }
  }

  /* ================= AUTO LOGIN ================= */
  window.addEventListener('DOMContentLoaded', async () => {
    if (autoLoginDisabled) return;

    rowId = new URLSearchParams(window.location.search).get('row_id') || localStorage.getItem('rowId');
    loginCode = localStorage.getItem('loginCode');

    if (rowId && loginCode) {
      setAuthState(true);
    }
  });

  /* ================= LOGIN SUBMIT ================= */
  async function submitRowId(event) {
    if (event) event.preventDefault();
    if (isSubmitting) return;
    isSubmitting = true;
    autoLoginDisabled = false;

    const error = document.getElementById('loginError');
    const spinner = document.getElementById('spinner');
    rowId = rowId || document.getElementById('rowIdInput').value.trim();
    if (!rowId) {
      isSubmitting = false;
      error.textContent = 'Please enter a password';
      return;
    }

    error.textContent = '';
    spinner.style.display = 'block';
    stopCheckLoop();

    try {
      let code = null;

      // 1️⃣ Call checklast4 function
      const checkRes = await fetch(
        'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/checklast4',
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ row_id: rowId })
        }
      );
      const checkData = await checkRes.json();
      code = checkData?.code;

      // 2️⃣ Fallback: call verify-link function
      if (!code) {
        const verifyRes = await fetch(
          'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/verify-link',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ row_id: rowId })
          }
        );
        const verifyData = await verifyRes.json();
        code = verifyData?.code;
      }

      if (!code) {
        error.textContent = 'Login failed: no code found';
        return;
      }

      loginCode = code;
      localStorage.setItem('rowId', rowId);
      localStorage.setItem('loginCode', loginCode);
      setAuthState(true);

      // resume polling after 10s
      setTimeout(startCheckLoop, 10000);

    } catch (err) {
      console.error("Login error:", err);
      error.textContent = 'Server error';
    } finally {
      spinner.style.display = 'none';
      isSubmitting = false;
    }
  }

  /* ================= POLL SESSION ================= */
  async function checkLastLogin() {
    if (!rowId || !loginCode) return;

    try {
      const res = await fetch(
        'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/checklast4',
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ row_id: rowId })
        }
      );

      const data = await res.json();
      const latestCode = data?.code;

      if (!latestCode || latestCode !== loginCode) {
        setAuthState(false, 'session replaced');
      }

    } catch (err) {
      console.error('checkLastLogin error:', err);
      setAuthState(false, 'checklast exception');
    }
  }

  function startCheckLoop() {
    stopCheckLoop();
    checkInterval = setInterval(checkLastLogin, 5000);
  }

  function stopCheckLoop() {
    if (checkInterval) {
      clearInterval(checkInterval);
      checkInterval = null;
    }
  }

  /* ================= ENTER KEY SUBMIT ================= */
  document.getElementById('rowIdInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') submitRowId(e);
  });
  document.getElementById('loginBtn').addEventListener('click', submitRowId);

</script>

<style>
html, body { margin:0; height:100%; width:100%; font-family:Arial,sans-serif; background:#000; }
iframe { width:100%; height:100%; border:none; display:block; }
#loginOverlay { position:fixed; inset:0; background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999; color:#fff; }
#loginOverlay img { width:96px; height:96px; margin-bottom:16px; }
#loginOverlay input { padding:12px; font-size:16px; width:220px; border-radius:6px; border:none; margin-bottom:12px; }
#loginOverlay button { padding:12px 18px; font-size:16px; border-radius:6px; border:none; background:#007bff; color:#fff; cursor:pointer; }
#loginError { color:#ff4d4d; margin-top:12px; }
#spinner { border:4px solid rgba(255,255,255,0.2); border-top:4px solid #007bff; border-radius:50%; width:36px; height:36px; animation:spin 1s linear infinite; margin-top:12px; display:none; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <img src="./icon-1024x1024.png" alt="Logo">
  <h2>Enter Password</h2>
  <input type="password" id="rowIdInput" placeholder="Password">
  <button id="loginBtn">Submit</button>
  <div id="loginError"></div>
  <div id="spinner"></div>
</div>

<!-- APP -->
<iframe id="appFrame"></iframe>

</body>
</html>
